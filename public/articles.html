<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>è¨˜äº‹ä¸€è¦§ - Article Search</title>
  <link rel="stylesheet" href="/common.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
    .search-box {
      position: relative;
      margin-bottom: var(--space-md);
    }
    .search-box::before {
      content: "ğŸ”";
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      pointer-events: none;
    }
    .search-box .input {
      padding-left: 44px;
    }
    
    /* ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰ */
    .tag-cloud {
      margin-bottom: var(--space-md);
    }
    .tag-cloud__title {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-bottom: 12px;
    }
    .tag-cloud__list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }
    .tag-cloud__tag {
      padding: var(--space-sm) 14px;
      font-size: 14px;
      font-weight: 500;
    }
    .tag-cloud__tag .count {
      font-size: 12px;
      opacity: 0.7;
      margin-left: 6px;
    }
    
    /* è¨˜äº‹ãƒªã‚¹ãƒˆ */
    .article-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .article-card__title {
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: var(--space-sm);
    }
    .article-card__title a {
      color: var(--color-text);
      text-decoration: none;
    }
    .article-card__title a:active { opacity: 0.7; }
    .article-card__summary {
      font-size: 14px;
      color: var(--color-text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .article-card__meta {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-sm);
      font-size: 12px;
      color: var(--color-text-muted);
    }
    .article-card__tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }
    .article-card__memo {
      font-size: 13px;
      color: var(--color-text-secondary);
      font-style: italic;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--color-border);
    }
    
    /* å±•é–‹ãƒœã‚¿ãƒ³ */
    .expand-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--color-bg);
      border: none;
      padding: var(--space-sm) 14px;
      border-radius: var(--radius-md);
      font-size: 13px;
      color: var(--color-text-secondary);
      cursor: pointer;
      margin-top: 12px;
      -webkit-tap-highlight-color: transparent;
    }
    .expand-btn:active { background: var(--color-border); }
    
    /* è¨˜äº‹å†…å®¹ */
    .article-content {
      display: none;
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .article-content.show { display: block; }
    .article-content h1, .article-content h2, .article-content h3 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .article-content p {
      margin-bottom: 14px;
      line-height: 1.8;
      font-size: 15px;
    }
    .article-content ul, .article-content ol {
      margin-left: 20px;
      margin-bottom: 14px;
    }
    .article-content li { margin-bottom: 6px; }
    .article-content code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }
    .article-content pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: var(--space-md);
      border-radius: var(--radius-md);
      overflow-x: auto;
      margin-bottom: 14px;
      font-size: 13px;
    }
    .article-content pre code { background: none; padding: 0; }
    .article-content a { color: var(--color-primary); }
    .article-content img {
      max-width: 100%;
      height: auto;
      border-radius: var(--radius-md);
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ“‹ è¨˜äº‹ä¸€è¦§</h1>
    <nav class="header-nav">
      <a href="/">ğŸ“ è¿½åŠ </a>
      <a href="/search.html">ğŸ” æ¤œç´¢</a>
      <a href="/ask.html">ğŸ’¬ è³ªå•</a>
      <a href="/feed.xml">ğŸ“¡ RSS</a>
    </nav>
  </header>
  
  <main class="main">
    <div class="search-box">
      <input type="text" class="input" id="searchInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„è¦ç´„ã§æ¤œç´¢...">
    </div>
    
    <div class="card tag-cloud" id="tagCloud" style="display: none;">
      <div class="tag-cloud__title">ğŸ·ï¸ ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿</div>
      <div class="tag-cloud__list" id="tagCloudTags"></div>
    </div>
    
    <div class="text-muted text-sm mb-sm" id="filterStatus" style="display: none;"></div>
    
    <div id="content">
      <div class="state">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </main>
  
  <nav class="bottom-nav">
    <a href="/" class="bottom-nav__item"><span class="bottom-nav__icon">ğŸ“</span>è¿½åŠ </a>
    <a href="/articles.html" class="bottom-nav__item bottom-nav__item--active"><span class="bottom-nav__icon">ğŸ“‹</span>ä¸€è¦§</a>
    <a href="/search.html" class="bottom-nav__item"><span class="bottom-nav__icon">ğŸ”</span>æ¤œç´¢</a>
    <a href="/ask.html" class="bottom-nav__item"><span class="bottom-nav__icon">ğŸ’¬</span>è³ªå•</a>
  </nav>

  <script>
    const STOP_WORDS = new Set([
      'cookie', 'cookies', 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼', 'è¨­å®š', 'åºƒå‘Š', 'privacy',
      'åˆ©ç”¨è¦ç´„', 'terms', 'ãƒãƒªã‚·ãƒ¼', 'policy'
    ]);
    
    function normalizeTag(tag) { return tag ? tag.trim() : ''; }
    function isStopWord(tag) { return STOP_WORDS.has(tag.toLowerCase()); }
    
    let allArticles = [];
    let selectedTags = new Set();
    let searchQuery = '';
    
    async function loadArticles() {
      const content = document.getElementById('content');
      
      try {
        const response = await fetch('/api/articles?limit=100');
        const data = await response.json();
        
        if (!response.ok) {
          content.innerHTML = `<div class="state state--error">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
          return;
        }
        
        allArticles = data.articles || [];
        
        if (allArticles.length === 0) {
          content.innerHTML = '<div class="state">ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        
        renderTagCloud();
        renderArticles();
      } catch (error) {
        content.innerHTML = `<div class="state state--error">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
      }
    }
    
    function renderTagCloud() {
      const tagCounts = {};
      
      allArticles.forEach(article => {
        (article.tags || []).forEach(tag => {
          const normalized = normalizeTag(tag);
          if (normalized && !isStopWord(normalized)) {
            tagCounts[normalized] = (tagCounts[normalized] || 0) + 1;
          }
        });
      });
      
      const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);
      
      if (sortedTags.length === 0) {
        document.getElementById('tagCloud').style.display = 'none';
        return;
      }
      
      const tagsHtml = sortedTags.map(([tag, count]) => `
        <button class="tag tag-cloud__tag ${selectedTags.has(tag) ? 'tag--active' : ''}" 
                onclick="toggleTag('${escapeAttr(tag)}')">${escapeHtml(tag)}<span class="count">${count}</span></button>
      `).join('');
      
      document.getElementById('tagCloudTags').innerHTML = tagsHtml + 
        (selectedTags.size > 0 ? '<button class="tag" style="background:var(--color-border);color:var(--color-text-secondary)" onclick="clearTags()">ã‚¯ãƒªã‚¢</button>' : '');
      document.getElementById('tagCloud').style.display = 'block';
    }
    
    function toggleTag(tag) {
      selectedTags.has(tag) ? selectedTags.delete(tag) : selectedTags.add(tag);
      renderTagCloud();
      renderArticles();
    }
    
    function clearTags() {
      selectedTags.clear();
      renderTagCloud();
      renderArticles();
    }
    
    function filterArticles() {
      return allArticles.filter(article => {
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          if (!(article.title || '').toLowerCase().includes(q) && 
              !(article.summary || '').toLowerCase().includes(q)) return false;
        }
        if (selectedTags.size > 0) {
          const articleTags = (article.tags || []).map(t => normalizeTag(t));
          if (![...selectedTags].every(tag => articleTags.includes(tag))) return false;
        }
        return true;
      });
    }
    
    function renderArticles() {
      const filtered = filterArticles();
      const content = document.getElementById('content');
      const filterStatus = document.getElementById('filterStatus');
      
      if (searchQuery || selectedTags.size > 0) {
        filterStatus.style.display = 'block';
        filterStatus.textContent = `${filtered.length}ä»¶ / ${allArticles.length}ä»¶`;
      } else {
        filterStatus.style.display = 'none';
      }
      
      if (filtered.length === 0) {
        content.innerHTML = '<div class="state">è©²å½“ã™ã‚‹è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      content.innerHTML = `
        <ul class="article-list">
          ${filtered.map((article, index) => `
            <li class="card">
              <h2 class="article-card__title">
                <a href="${escapeAttr(article.url)}" target="_blank" rel="noopener">${escapeHtml(article.title)}</a>
              </h2>
              ${article.summary ? `<p class="article-card__summary">${escapeHtml(article.summary)}</p>` : ''}
              <div class="article-card__meta">
                <span>${formatDate(article.scraped_at)}</span>
                ${article.publish_rss ? '<span class="tag tag--rss tag--badge">RSS</span>' : ''}
              </div>
              ${article.tags && article.tags.length > 0 ? `
                <div class="article-card__tags">
                  ${article.tags.map(t => normalizeTag(t)).filter(t => t && !isStopWord(t)).slice(0, 5)
                    .map(tag => `<button class="tag" onclick="toggleTag('${escapeAttr(tag)}')">${escapeHtml(tag)}</button>`).join('')}
                </div>
              ` : ''}
              ${article.memo ? `<p class="article-card__memo">ğŸ“ ${escapeHtml(article.memo)}</p>` : ''}
              ${article.full_content ? `
                <button class="expand-btn" onclick="toggleContent(${index})">ğŸ“„ å†…å®¹ã‚’è¦‹ã‚‹</button>
                <div class="article-content" id="content-${index}">${renderMarkdown(article.full_content)}</div>
              ` : ''}
            </li>
          `).join('')}
        </ul>
      `;
    }
    
    function toggleContent(index) {
      const el = document.getElementById(`content-${index}`);
      if (el) el.classList.toggle('show');
    }
    
    function renderMarkdown(text) {
      try { return marked.parse(text || ''); } catch { return escapeHtml(text); }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function escapeAttr(text) {
      return (text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '';
      return new Date(dateStr).toLocaleDateString('ja-JP', {
        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
      searchQuery = e.target.value.trim();
      renderArticles();
    });
    
    loadArticles();
  </script>
</body>
</html>
